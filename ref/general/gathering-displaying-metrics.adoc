// Copyright (c) 2019 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//     IBM Corporation
//
:page-description: Learn how to gather metric data by using Prometheus and display that data by creating graphs in Grafana.
:seo-title: Gathering and displaying Open Liberty metrics
:seo-description: Learn how to gather metric data by using Prometheus and display that data by creating graphs in Grafana.
:page-layout: general-reference
:page-type: general
= Gathering and displaying Open Liberty metrics

:url-dashboard: https://grafana.com/dashboards/8022
:url-dashboard-github: https://github.com/Azquelt/microprofile-faulttolerance11-dashboard
:url-sample-app: https://github.com/Azquelt/faulttolerance-metrics-example
:url-ft11-spec: https://github.com/eclipse/microprofile-fault-tolerance/releases/tag/1.1.2
:url-ft11-spec-metrics: http://download.eclipse.org/microprofile/microprofile-fault-tolerance-1.1.2/microprofile-fault-tolerance-spec.html#_integration_with_microprofile_metrics
:url-rate: https://prometheus.io/docs/prometheus/latest/querying/functions/#rate()
:url-ol-download: https://openliberty.io/downloads/
:url-ol-ft-guide: https://github.com/OpenLiberty/iguide-retry-timeout/tree/master/finish
:url-prom-config: https://prometheus.io/docs/prometheus/latest/configuration/configuration/
:url-admin-role: https://openliberty.io/docs/ref/config/#rwlp_config_administrator-role.html
:url-7zip: https://www.7-zip.org/
:url-metrics11-spec: https://github.com/eclipse/microprofile-metrics/releases/tag/1.1.1
:url-prom-docs: https://prometheus.io/docs/introduction/overview/
:url-prom-ql: https://prometheus.io/docs/prometheus/latest/querying/basics/
:url-prom-best-practise: https://prometheus.io/docs/practices/naming/
:url-prom-alerts: https://prometheus.io/docs/alerting/overview/
:url-grafana-docs: http://docs.grafana.org/
:url-grafana-alerts: http://docs.grafana.org/alerting/rules/
:url-iguide-recover: https://openliberty.io/guides/retry-timeout.html
:url-iguide-limit: https://openliberty.io/guides/bulkhead.html
:url-guide-fallback: https://openliberty.io/guides/microprofile-fallback.html
:url-guide-circuitbreaker: https://openliberty.io/guides/circuit-breaker.html

After metrics are built into your application, you can gather the metric data by using Prometheus and display that data by creating graphs in Grafana.

The following steps show you how to configure Prometheus and Grafana to gather and display metrics from Open Liberty. They assume that you already have metrics on the `/metrics` endpoint.

== Gather metrics using Prometheus

. Download https://prometheus.io/download/#prometheus[Prometheus] and extract it.

. Edit the `prometheus.yml` file to configure Prometheus to gather metrics from your Open Liberty server. The `scrape_configs` section at the bottom of the file has one job that is configured for Prometheus. After that information, add the following new job information for Open Liberty:
+
[source, yaml]
----
  - job_name: 'openliberty'

    basic_auth:
      username: 'adminusername'
      password: 'adminpassword'

    scheme: 'https'

    tls_config:
            insecure_skip_verify: true

    static_configs:
            - targets: ['localhost:9443']

----
+
If you have a slightly different setup, check {url-prom-config}[Prometheus' configuration documentation] for the other options that can be specified.

. Run the `./prometheus` command (or the `prometheus.exe` command on Windows), and you see logs that show that Prometheus is starting up. Go to http://localhost:9090/ to see the Prometheus web UI.

== Display metrics using Grafana

Although Prometheus has a basic web UI that can draw graphs from collected metrics, Grafana has powerful features that can be used to display effective graphs.

. Download link:https://grafana.com/grafana/download[Grafana] and extract it.

. Start Grafana by using the `bin/grafana-server` command, and go to the web UI in your browser. The default web UI is http://localhost:3000, the default log in user is `admin`, and the default log in password is `admin`.

This dashboard shows a selection of graphs for a single method. Because the dashboard shows only metrics for a single method, it isnâ€™t the best option to display an overview of your entire system. However, because it does display all available details, it can be helpful when you need to determine the cause of a problem.

== Create your own graphs

When you create your own graphs, you can extract metric data from several different methods and display it all on the same dashboard.

Metric names are passed to the MicroProfile Metrics API, which exports them in a format that conforms to {url-prom-best-practise}[Prometheus best practices]. The MicroProfile Metrics API makes the following changes to metrics when they are exported to Prometheus:

* Metrics are put in the `application` namespace.
* Dots are replaced with underscores.
* `camelCase` words are separated by underscores.
* The entire name is converted to lowercase.
* Metrics that measure time are rescaled and reported in seconds, and `_seconds` is appended to the name.
* Histogram metrics are split into percentiles, limits, mean, and standard deviation.

'''

Use the following steps to create a new empty graph and navigate to the query field:

. In Grafana, create an empty dashboard:
+
image::/docs/img/ftmetrics-grafana-new-dashboard.png[Screenshot of Grafana highlighting the new dashboard button on the left sidebar menu]
{empty} +

. Add a new panel and choose Graph as the new panel type:
+
image::/docs/img/ftmetrics-grafana-new-graph.png[Screenshot of Grafana highlighting the new panel button and the graph button]
{empty} +

. Click Edit from the panel header menu:
+
image::/docs/img/ftmetrics-grafana-edit-graph.png[Screenshot of Grafana with the menu of the new panel open highlighting the edit button]
{empty} +

. Select the Metrics tab:
+
image::/docs/img/ftmetrics-grafana-metrics-tab.png[Screenshot of Grafana showing the graph editing screen with the metrics tab open]
{empty} +

Now you can graph your metric data by using {url-prom-ql}[Prometheus Query Language] in the query field.

'''

You can graph the total number of calls to a particular method. For example, graph the total number of calls to the `exampleMethod` method by using the following query:

----
application:example_method_invocations_total
----

The following example graph displays the number of times the method was called:

[INSERT EXAMPLE IMAGE]

'''

You can track the rate of requests to a method by using the `{url-rate}[rate]` query. The rate is calculated by averaging the total number of invocations over the preceding minute. For example, graph the rate of requests to the `exampleMethod` method by using the following query:

----
rate(application:example_method_invocations_total[1m])
----

The following example graph displays how many requests the method receives per second:

[INSERT EXAMPLE IMAGE]

See the link:https://grafana.com/docs/[Grafana documentation] for more information on configuring Grafana and depicting metric data.

=== See also:
* Guide: link:/guides/microprofile-metrics.html[Providing metrics from a microservice]
* link:/docs/ref/genera/#metrics-catalog.html[Metrics reference list]
* link:/docs/ref/general/#microservice_observability_metrics.html[Microservice observability with metrics]
* link:https://github.com/eclipse/microprofile-metrics[MicroProfile Metrics]
* link:https://prometheus.io/docs/[Prometheus documentation]
* link:https://grafana.com/docs/[Grafana documentation]
